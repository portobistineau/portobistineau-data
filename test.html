<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Bistineau Weather & Solunar - TEST</title>
    <style>
        body {font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f0f8ff;}
        .banner {width: 100%; text-align: center;}
        .banner-img {max-width: 100%; height: auto;}
        .tagline {text-align: center; font-style: italic; color: #003366; margin: 10px 0;}
        h2 {color: #003366; text-align: center;}
    </style>
</head>
<body>

<!-- BANNER — FULL WIDTH, PERFECT ON MOBILE -->
<div class="banner">
  <img src="banner.jpg" alt="Port O Bistineau Marina" class="banner-img" id="banner">
</div>
<p class="tagline">Your Gateway to Lake Bistineau – Live Lake Views, Lake Updates & More</p>

<script>
  // SECRET DOUBLE-CLICK: index.html → test.html | test.html → stay
  let clicks = 0, timer;
  document.getElementById('banner').addEventListener('click', function(e) {
    clicks++;
    if (clicks === 1) {
      timer = setTimeout(() => clicks = 0, 400);
    } else if (clicks === 2) {
      clearTimeout(timer);
      clicks = 0;
      if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
        window.location.href = 'test.html';
      }
    }
  });
</script>

<!-- Weather -->
<div class="section">
  <h2>Lake Bistineau Weather</h2>
  <div id="bistineauWeather"></div>
  <div id="dayDetail" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:999;max-width:90%;max-height:90%;overflow:auto;font-family:Arial;"></div>
  <div id="overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:998;" onclick="this.style.display='none';document.getElementById('dayDetail').style.display='none';"></div>
  <script>
  const lat = 32.4066, lon = -93.3906;
  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,apparent_temperature,precipitation_probability,wind_speed_10m,wind_direction_10m,weather_code,pressure_msl,cloud_cover&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weather_code&forecast_days=9&timezone=America%2FChicago&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`)
  .then(r=>r.json())
  .then(w=>{
    const now = new Date();
    const todayISO = now.toLocaleDateString('en-CA');
    let todayIndex = w.daily.time.findIndex(d => d === todayISO);
    if (todayIndex === -1) todayIndex = 1;
    const currentHourStr = now.toISOString().slice(0,13) + ':00';
    const hourIndex = w.hourly.time.indexOf(currentHourStr);
    const prevIndex = hourIndex - 1;
    const c = w.hourly;
    const temp = Math.round(c.temperature_2m[hourIndex]);
    const feels = Math.round(c.apparent_temperature[hourIndex]);
    const wind = Math.round(c.wind_speed_10m[hourIndex]);
    const dir = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(c.wind_direction_10m[hourIndex]/22.5)%16];
    const precip = c.precipitation_probability[hourIndex];
    const pressureNow = (c.pressure_msl[hourIndex] / 33.8639).toFixed(2);
    const pressurePrev = prevIndex >= 0 ? c.pressure_msl[prevIndex] / 33.8639 : pressureNow;
    const diff = pressureNow - pressurePrev;
    const trend = diff > 0.03 ? 'Rising' : diff < -0.03 ? 'Falling' : 'Steady';
    const timeStr = now.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});
    const currentHTML = `
      <div style="background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <div style="font-size:28px;font-weight:bold;">${temp}°F</div>
        <div style="color:#666;margin-bottom:8px;">Feels ${feels}°F • As of ${timeStr}</div>
        <div style="font-size:14px;line-height:1.6;">
          Wind ${wind} mph ${dir}<br>
          Rain chance ${precip}%<br>
          Pressure ${pressureNow} inHg <strong>${trend}</strong><br>
          Cloud cover ${c.cloud_cover ? c.cloud_cover[hourIndex] : 0}%
        </div>
      </div>`;
    let forecastHTML = '';
    for(let i = 0; i < 7; i++){
      const idx = todayIndex + i;
      const thisDate = new Date(w.daily.time[idx] + 'T12:00:00');
      const dayName = i === 0 ? 'Today' : thisDate.toLocaleDateString('en-US', {weekday: 'short'});
      const hi = Math.round(w.daily.temperature_2m_max[idx]);
      const lo = Math.round(w.daily.temperature_2m_min[idx]);
      const rain = w.daily.precipitation_probability_max[idx] || 0;
      const code = w.daily.weather_code[idx];
      forecastHTML += `
        <div onclick="showDetail('${w.daily.time[idx]}')" style="cursor:pointer;display:inline-block;width:105px;margin:4px;vertical-align:top;background:#fff;padding:8px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);text-align:center;font-size:13px;">
          <div style="font-weight:bold;color:#003366;">${dayName}</div>
          <img src="/images/${code}.svg" width="48" height="48" style="margin:4px 0;" onerror="this.src='/images/3.svg'">
          <div style="font-size:16px;font-weight:bold;">${hi}°<span style="font-size:12px;color:#666;">/${lo}°</span></div>
          <div>${rain}% rain</div>
        </div>`;
    }
    document.getElementById('bistineauWeather').innerHTML = currentHTML +
      `<div style="background:#f0f8ff;padding:10px;border-radius:15px;overflow-x:auto;white-space:nowrap;">${forecastHTML}</div>`;
    window.showDetail = function(isoDate){
      const date = new Date(isoDate + 'T12:00:00');
      const startHour = w.hourly.time.findIndex(t => t.startsWith(isoDate));
      let detailHTML = `<h3 style="margin-top:0;text-align:center;">${date.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric'})}</h3><div style="max-height:60vh;overflow-y:auto;">`;
      for(let h = 0; h < 24; h++){
        const idx = startHour + h;
        if(idx >= w.hourly.time.length) break;
        const hourTime = new Date(w.hourly.time[idx]);
        const tempH = Math.round(w.hourly.temperature_2m[idx]);
        const windH = Math.round(w.hourly.wind_speed_10m[idx]);
        const dirH = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round(w.hourly.wind_direction_10m[idx]/22.5)%16];
        const rainH = w.hourly.precipitation_probability[idx];
        const codeH = w.hourly.weather_code[idx];
        detailHTML += `
          <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;">
            <div style="width:50px;">${hourTime.toLocaleTimeString('en-US',{hour:'numeric'})}</div>
            <img src="/images/${codeH}.svg" width="32" height="32" onerror="this.src='/images/3.svg'">
            <div style="width:60px;text-align:right;">${tempH}°F</div>
            <div style="width:70px;">${windH} mph ${dirH}</div>
            <div style="width:50px;text-align:right;">${rainH}%</div>
          </div>`;
      }
      detailHTML += `</div><div style="text-align:center;margin-top:10px;"><button onclick="document.getElementById('overlay').style.display='none';document.getElementById('dayDetail').style.display='none';" style="padding:8px 16px;background:#003366;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button></div>`;
      document.getElementById('dayDetail').innerHTML = detailHTML;
      document.getElementById('dayDetail').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    };
  })
  .catch(()=>document.getElementById('bistineauWeather').innerHTML='<div style="padding:20px;text-align:center;color:#c00;">Weather offline – refresh</div>');
  </script>
</div>

<!-- TODAY’S BITE FORECAST – 100% LOCAL, NO API -->
<div style="margin:30px auto;max-width:1000px;background:white;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:Arial;">
  <h2 style="text-align:center;margin:0 0 20px;color:#000;font-size:28px;">
  Solunar Times for <span id="header-date">Loading...</span>
</h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <div style="flex:2;background:#f8fdff;padding:25px;border-radius:12px;">
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px 10px;line-height:1.35;font-size:16px;">
        <b>First Light</b> <div id="first" style="text-align:right;">—</div>
        <b>Sunrise</b> <div id="rise" style="text-align:right;">—</div>
        <b>Major Period 1</b> <div id="maj1" style="text-align:right;">—</div>
        <b>Major Period 2</b> <div id="maj2" style="text-align:right;">—</div>
        <b>Minor Period 1</b> <div id="min1" style="text-align:right;">—</div>
        <b>Minor Period 2</b> <div id="min2" style="text-align:right;">—</div>
        <b>Sunset</b> <div id="set" style="text-align:right;">—</div>
        <b>Last Light</b> <div id="last" style="text-align:right;">—</div>
      </div>
    </div>
    <div style="flex:1;background:white;padding:25px;border-radius:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
      <div id="rating" style="font-size:30px;color:#000;line-height:1.5;">Loading…</div>
      <div id="moon-bg" style="width:90px;height:90px;background:#002244;border-radius:50%;margin:12px auto;padding:5px;">
        <img id="moon-img" src="" width="80" height="80" style="border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
      </div>
      <div id="phase" style="font-weight:bold;font-size:16px;color:#000;margin:8px 0 4px;">—</div>
      <div id="illum" style="color:#000;font-size:16px;">—</div>
    </div>
  </div>
  <p style="text-align:center;color:#003366;font-size:12px;margin-top:22px;">
    Updated <span id="date">—</span> – Refresh for latest
  </p>
</div>

<script>
// SUNCalc.js - FULL LOCAL SUN + MOON (NO API CALLS EVER)
var SunCalc={addTime:function(e,t,n){this.times.push([e,t,n])},times:[[.0001,"nadir","Nadir"],[-.0078,"nightEnd","Night ends"],[-.1047,"nauticalDawn","Nautical dawn"],[-.1517,"blueHourDawnEnd","Blue hour ends"],[-.2075,"dawn","Dawn"],[-.2167,"blueHourDawnStart","Blue hour starts"],[-.5,"sunriseEnd","Sunrise ends"],[-.5833,"sunrise","Sunrise"],[-.8333,"goldenHourDawnEnd","Golden hour (morning) ends"],[0,"solarNoon","Solar noon"],[.0001,"goldenHourDuskStart","Golden hour (evening) starts"],[.0083,"sunsetStart","Sunset starts"],[.0083,"sunset","Sunset"],[.0083,"sunsetEnd","Sunset ends"],[.0083,"dusk","Dusk"],[.0083,"blueHourDuskStart","Blue hour starts"],[.0083,"blueHourDuskEnd","Blue hour ends"],[.0083,"nauticalDusk","Nautical dusk"],[.0083,"night","Night starts"],[.0001,"goldenHourDuskEnd","Golden hour (evening) ends"]],getPosition:function(e,t,n){var i=SunCalc.getJulian(e),a=(i-2451545)/36525,r=21.448- a*(.00023 + a*(1934.136 + a*(.000007 + a*.00000072))),o=180+ a*(.00059 - a*.00031),s=280.46646 + a*(36000.76983 + a* .000303),l=s + 1.9146 * Math.sin(o*Math.PI/180) + .019993 * Math.sin(2*o*Math.PI/180) + .00029 * Math.sin(3*o*Math.PI/180),u=!0,m=l%360;m<0&&(m+=360);var c=Math.asin(Math.sin(r*Math.PI/180)*Math.sin(l*Math.PI/180)),d=Math.sin(c),h=Math.cos(c),p=t*Math.PI/180,f=n*Math.PI/180,g=(s - m)/360 % 1,v=Math.acos((Math.sin(0) - Math.sin(p)*d)/ (Math.cos(p)*h));return v=isNaN(v)?0:v,{azimuth:Math.atan2(Math.sin(v*Math.PI),Math.cos(v*Math.PI)*Math.sin(p) - Math.tan(c)*Math.cos(p)) + Math.PI,altitude:c}},getTimes:function(e,t,n,i){i=i||0;for(var a=SunCalc.getJulian(e),r=a-2451545,o=(r+ .0009 + (n + i/60)/360) % 1,s=6.697374558 + 22.6589*r % 24,l=!0,u=0;u<24;u++){var m=Math.sin(o*Math.PI/180),c=Math.sin(t*Math.PI/180),d=Math.cos(o*Math.PI/180),h=Math.cos(t*Math.PI/180),p=-Math.sin(c)/ (Math.cos(c)*d),f=Math.sqrt(1-p*p),g=p/f,v=Math.atan(g)*180/Math.PI;v<0&&(v+=360);var y=SunCalc.times[u][0] * f,M=SunCalc.times[u][1],w=SunCalc.times[u][2];if(Math.abs(y)>1)continue;var T=(y - m)/d;b=T>1?b=0:b<-1?b=1:b;var S=s + T/15,P=new Date(e);P.setHours(Math.floor(S)),P.setMinutes(Math.floor(60*(S%1))),P.setSeconds(0),this.times[u][3]=P}},getMoonPosition:function(e,t,n){var i=SunCalc.getJulian(e),a=i-2451545,r= (a + .0009 + n/360) % 1,s=6.289 + 11.597 * a % 24,l=64.9755 + .6963 * a % 360,u=4.9087 + .6881 * a % (2*Math.PI),m= .0026 + 1.5e-7 * a,c= .6583 * Math.sin(m),d=u + c,h= l + .00396 * Math.sin(m) + .0013 * Math.sin(2*u) + .0004 * Math.sin(3*u) + .0003 * Math.sin(2*l),p= Math.sin(d),f= Math.cos(d),g= Math.sin(h),v= Math.cos(h),y= Math.sin(t*Math.PI/180),M= Math.cos(t*Math.PI/180),w= p * y + f * M * v,T= Math.sqrt(1 - w*w),S= Math.atan2(T, w),P= Math.asin(w),b= S + Math.PI;return{distance:6378.14 / T,azimuth:b,altitude:P,parallacticAngle:Math.atan2(Math.sin(b),Math.tan(t*Math.PI/180)*Math.cos(P) - Math.sin(P)*Math.cos(b))}},getMoonIllumination:function(e){var t=SunCalc.getJulian(e),n=t-2451545,i=n/29.530588853,a=i-Math.floor(i),r= (a + .000133)*2*Math.PI,o= 4.8816279 + 628.3319669 * n,s= 5.1984667 + 523.580607 * n,l= .00257 + .00000015 * n,u= Math.sin(l),m= o + u,c= 5.1677 + 777.987 + n * .00000015,d= Math.sin(c),h= r - s,p= Math.sqrt(1 - Math.cos(h)*Math.cos(h)),f= p * Math.cos(r - m),g= p * Math.sin(r - m),v= Math.atan2(g,f),y= v + Math.PI,M= 1 - Math.cos(h)/2;return{fraction:M,phase:a,angle:y}},getMoonTimes:function(e,t,n,i){var a=SunCalc.getJulian(e),r=a-2451545,o= (r + .0009 + n/360) % 1,s=6.289 + 11.597 * r % 24,l=!0,u=0,m=null,c=null,d=null;for(u=0;u<48;u++){var h=SunCalc.getMoonPosition(e,t,n),p=h.altitude,f=h.distance;if(p>0&&m===null)m=u/2;if(p<0&&m!==null&&c===null)c=u/2;if(p>0&&c!==null)d=u/2- c}var g=null,v=null;if(m!==null&&c!==null){g=new Date(e);g.setHours(g.getHours() + m);v=new Date(e);v.setHours(v.getHours() + c)}return{rise:g,set:v,alwaysUp:l,alwaysDown:!l}}}; // end SunCalc

// TODAY’S BITE FORECAST – 100% LOCAL SUNCalc.js (NO API CALLS)
(() => {
  const lat = 32.4619, lng = -93.34883;
  const now = new Date();
  const today = now.toLocaleDateString('en-US', {month: 'long', day: 'numeric'});

  // SUN TIMES (local SunCalc)
  SunCalc.getTimes(now, lat, lng);
  const fmt = d => d ? d.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : '—';
  document.getElementById('first').textContent = fmt(SunCalc.times.find(t => t[1] === 'dawn')[3]);
  document.getElementById('rise').textContent = fmt(SunCalc.times.find(t => t[1] === 'sunrise')[3]);
  document.getElementById('set').textContent = fmt(SunCalc.times.find(t => t[1] === 'sunset')[3]);
  document.getElementById('last').textContent = fmt(SunCalc.times.find(t => t[1] === 'dusk')[3]);

  // MOON TIMES & ILLUMINATION (local SunCalc)
  const moonTimes = SunCalc.getMoonTimes(now, lat, lng);
  const moonIllum = SunCalc.getMoonIllumination(now);
  const illum = Math.round(moonIllum.fraction * 100);

  // SOLUNAR PERIODS
  const rise = moonTimes.rise;
  const set = moonTimes.set;
  const overhead = rise && set ? new Date(rise.getTime() + (set.getTime() - rise.getTime()) / 2) : null;
  const underfoot = overhead ? new Date(overhead.getTime() + 12*3600000) : null;

  const range = (center, hours) => {
    if (!center) return '—';
    const start = new Date(center);
    start.setMinutes(start.getMinutes() - hours * 30);
    const end = new Date(center);
    end.setMinutes(end.getMinutes() + hours * 30);
    return `${fmt(start)}–${fmt(end)}`;
  };

  document.getElementById('maj1').textContent = range(overhead, 2);
  document.getElementById('maj2').textContent = range(underfoot, 2);
  document.getElementById('min1').textContent = range(rise, 1);
  document.getElementById('min2').textContent = range(set, 1);

  // RATING & PHASE
  const ratingScore = illum > 75 || illum < 25 ? 4 : illum > 50 ? 3 : 2;
  const stars = '★★★★'.slice(0, ratingScore);
  const ratingText = ['','Fair','Good','Better','Best'][ratingScore];

  let phaseName = moonIllum.phase < 0.125 || moonIllum.phase > 0.875 ? 'New Moon' :
                  moonIllum.phase < 0.25 ? 'Waxing Crescent' :
                  moonIllum.phase < 0.375 ? 'Waxing Gibbous' :
                  moonIllum.phase < 0.5 ? 'Full Moon' :
                  moonIllum.phase < 0.625 ? 'Waning Gibbous' :
                  moonIllum.phase < 0.75 ? 'Waning Crescent' :
                  moonIllum.phase < 0.875 ? 'Last Quarter' : 'First Quarter';

  document.getElementById('rating').innerHTML = stars + '<br><span style="font-size:30px;color:#003366;">' + ratingText + '</span>';
  document.getElementById('phase').textContent = phaseName;
  document.getElementById('illum').textContent = `${illum}% Illumination`;

  let moonFile = '';
  if (illum === 0) moonFile = 'newmoon.png';
  else if (illum === 100) moonFile = 'fullmoon.png';
  else if (illum === 50 && phaseName.includes('First')) moonFile = 'firstquart.png';
  else if (illum === 50 && phaseName.includes('Last')) moonFile = 'lastquart.png';
  else {
    const p = phaseName.includes('Waxing') ? 'wax' : 'wane';
    const pct = Math.round(illum / 5) * 5;
    moonFile = `${p}${pct}.png`;
  }
  document.getElementById('moon-img').src = `/images/${moonFile}`;

  document.getElementById('header-date').textContent = today;
  document.getElementById('date').textContent = now.toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'});
})();
</script>

</body>
</html>










