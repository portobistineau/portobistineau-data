<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Bistineau Weather & Solunar - TEST</title>
    <style>
        body {font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f0f8ff;}
        .banner {width: 100%; text-align: center;}
        .banner-img {max-width: 100%; height: auto;}
        .tagline {text-align: center; font-style: italic; color: #003366; margin: 10px 0;}
        h2 {color: #003366; text-align: center;}
    </style>
</head>
<body>

<!-- BANNER — FULL WIDTH, PERFECT ON MOBILE -->
<div class="banner">
  <img src="banner.jpg" alt="Port O Bistineau Marina" class="banner-img" id="banner">
</div>
<p class="tagline">Your Gateway to Lake Bistineau – Live Lake Views, Lake Updates & More</p>

<script>
  // SECRET DOUBLE-CLICK: index.html → test.html | test.html → stay
  let clicks = 0, timer;
  document.getElementById('banner').addEventListener('click', function(e) {
    clicks++;
    if (clicks === 1) {
      timer = setTimeout(() => clicks = 0, 400);
    } else if (clicks === 2) {
      clearTimeout(timer);
      clicks = 0;
      if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
        window.location.href = 'test.html';
      }
    }
  });
</script>

<!-- LAKE BISTINEAU WEATHER – FINAL, 100% NWS, CORRECT CARDS + SPACING -->
<div style="margin:30px auto;max-width:1000px;background:white;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:Arial;">
  <h2 style="text-align:center;margin:0 0 20px;color:#003366;font-size:28px;">
    Lake Bistineau Weather
  </h2>
  <div style="display:flex;gap:15px;flex-wrap:wrap;justify-content:center;">
    <div id="daily-cards">Loading NWS data…</div>
  </div>
  <p style="text-align:center;color:#003366;font-size:12px;margin-top:20px;">
    Powered by National Weather Service – <span id="weather-date">—</span>
  </p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const lat = 32.4619, lon = -93.3486;
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  // FULL CACHE – 15 minutes
  let cache = JSON.parse(localStorage.getItem('nwsFullCache') || 'null');
  if (cache && cache.date === today && Date.now() - cache.time < 900000) {
    renderNWS(cache.data);
  } else {
    fetch(`https://api.weather.gov/points/${lat},${lon}`)
      .then(r => r.json())
      .then(point => {
        const grid = point.properties;
        return Promise.all([
          fetch(grid.forecast),
          fetch(grid.forecastHourly),
          fetch(grid.observationStations).then(r => r.json()).then(st => fetch(st.observationStations[0] + '/observations/latest').then(r => r.json()))
        ]).then(([dailyRes, hourlyRes, obsRes]) => {
          return Promise.all([dailyRes.json(), hourlyRes.json(), obsRes.json()]).then(([daily, hourly, obs]) => {
            const data = {grid, daily: daily.properties, hourly: hourly.properties, obs: obs.properties};
            localStorage.setItem('nwsFullCache', JSON.stringify({date: today, time: Date.now(), data}));
            renderNWS(data);
          });
        });
      })
      .catch(() => document.getElementById('daily-cards').innerHTML = '<p style="color:red;text-align:center;">NWS offline – refresh in 30s</p>');
  }

  function renderNWS(data) {
    const dailyPeriods = data.daily.periods;
    const hourlyPeriods = data.hourly.periods;
    const obs = data.obs;

    // CURRENT OBSERVED
    const currentTemp = Math.round(obs.temperature.value * 1.8 + 32);
    const timeStr = new Date(obs.timestamp).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});

    // GROUP HOURLY BY DATE
    const hourlyByDate = {};
    hourlyPeriods.forEach(p => {
      const date = p.startTime.split('T')[0];
      if (!hourlyByDate[date]) hourlyByDate[date] = [];
      hourlyByDate[date].push(p);
    });

    // BUILD 5 DAILY CARDS
    const dates = Object.keys(hourlyByDate).slice(0,5);
    const cardsHTML = dates.map((date, i) => {
      const hours = hourlyByDate[date];
      const temps = hours.map(h => h.temperature);
      const high = Math.max(...temps);
      const low = Math.min(...temps);
      const dayName = i === 0 ? 'Today' : new Date(date).toLocaleDateString('en-US', {weekday:'short'});
      const icon = hours.find(h => h.isDaytime)?.icon || hours[0].icon;

      // 24-HOUR POPUP
      const rows = [];
      for (let h = 0; h < 24; h++) {
        const period = hours.find(p => new Date(p.startTime).getHours() === h) || {temperature: '—', probabilityOfPrecipitation: {value: 0}, shortForecast: 'No data', windSpeed: '0 mph', windDirection: '—'};
        const displayH = h === 0 ? 12 : h > 12 ? h - 12 : h;
        const ampm = h < 12 ? 'AM' : 'PM';
        rows.push(`
          <div style="display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #eee;font-size:14px;">
            <span>${displayH} ${ampm}</span>
            <img src="${period.icon.replace('large', 'small')}" width="32">
            <span>${period.temperature}°</span>
            <span>${period.probabilityOfPrecipitation.value || 0}%</span>
          </div>
        `);
      }

      return `
        <div style="background:#f8fdff;border-radius:12px;padding:15px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1);cursor:pointer;width:150px;"
             onclick="document.getElementById('popup-${i}').style.display='block'">
          <div style="font-weight:bold;margin-bottom:8px;">${dayName}</div>
          <img src="${icon.replace('large', 'medium')}" width="60">
          <div style="font-size:20px;margin:8px 0;"><b>${high}°</b>/<span style="color:#666;">${low}°</span></div>
          <div style="font-size:13px;color:#333;">${hours[0].shortForecast}</div>

          <div id="popup-${i}" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.4);z-index:999;width:340px;max-height:85vh;">
            <div style="padding:15px;background:#003366;color:white;border-radius:12px 12px 0 0;text-align:center;position:relative;">
              <b>${dayName}, ${new Date(date).toLocaleDateString('en-US',{month:'long',day:'numeric'})}</b>
              <span onclick="this.parentElement.parentElement.style.display='none'" style="position:absolute;right:12px;top:12px;cursor:pointer;font-size:24px;">×</span>
            </div>
            <div style="max-height:65vh;overflow-y:auto;">${rows.join('')}</div>
            <button onclick="document.getElementById('popup-${i}').style.display='none'"
                    style="width:100%;padding:12px;background:#003366;color:white;border:none;border-radius:0 0 12px 12px;cursor:pointer;font-size:16px;">Close</button>
          </div>
        </div>
      `;
    }).join('');

    document.getElementById('daily-cards').innerHTML = cardsHTML;
    document.getElementById('weather-date').textContent = now.toLocaleString('en-US',{month:'long',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'});
  }
});
</script>
</div>
    
<!-- TODAY’S BITE FORECAST – FINAL, KNIGHT TABLE (PUBLIC DOMAIN, EXACT SOLUNAR.ORG) -->
<div style="margin:30px auto;max-width:1000px;background:white;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:Arial;">
  <h2 style="text-align:center;margin:0 0 20px;color:#000;font-size:28px;">
    Solunar Times for <span id="header-date">—</span>
  </h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <div style="flex:2;background:#f8fdff;padding:25px;border-radius:12px;">
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px 10px;line-height:1.35;font-size:16px;">
        <b>First Light</b> <div id="first" style="text-align:right;">Calculating…</div>
        <b>Sunrise</b> <div id="rise" style="text-align:right;">Calculating…</div>
        <b>Major Period 1</b> <div id="maj1" style="text-align:right;">Calculating…</div>
        <b>Major Period 2</b> <div id="maj2" style="text-align:right;">Calculating…</div>
        <b>Minor Period 1</b> <div id="min1" style="text-align:right;">Calculating…</div>
        <b>Minor Period 2</b> <div id="min2" style="text-align:right;">Calculating…</div>
        <b>Sunset</b> <div id="set" style="text-align:right;">Calculating…</div>
        <b>Last Light</b> <div id="last" style="text-align:right;">Calculating…</div>
      </div>
      <p style="font-size:13px;color:#003366;margin-top:15px;text-align:center;">
        <b>Bold</b> periods indicate the stronger feeding time of each group.
      </p>
    </div>
    <div style="flex:1;background:white;padding:25px;border-radius:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
      <div id="rating" style="font-size:30px;color:#000;line-height:1.5;">Calculating…</div>
      <div id="moon-bg" style="width:90px;height:90px;background:#002244;border-radius:50%;margin:12px auto;padding:5px;">
        <img id="moon-img" src="" width="90" height="90" style="border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
      </div>
      <div id="phase" style="font-weight:bold;font-size:16px;color:#000;margin:8px 0 4px;">—</div>
      <div id="illum" style="color:#000;font-size:16px;">—</div>
      <div id="day-rating" style="font-weight:bold;font-size:18px;color:#003366;margin-top:6px;">—</div>
    </div>
  </div>
  <p style="text-align:center;color:#003366;font-size:12px;margin-top:22px;">
    Updated <span id="date">—</span> – Refresh for latest
  </p>
</div>

<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const lat = 32.4619, lng = -93.3486;
    const nowLocal = new Date();
    const fmtLocal = d => d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});

    // ---- SUN TIMES ----
    let sunData = JSON.parse(localStorage.getItem('sunCache') || 'null');
    const todayStr = nowLocal.toISOString().slice(0,10);
    if (!sunData || sunData.date !== todayStr) {
      fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`)
        .then(r => r.json())
        .then(j => {
          if (j.status === "OK") {
            sunData = {date: todayStr, data: j.results};
            localStorage.setItem('sunCache', JSON.stringify(sunData));
          }
        })
        .catch(() => {});
    }
    if (sunData) {
      document.getElementById('first').textContent = fmtLocal(new Date(sunData.data.civil_twilight_begin));
      document.getElementById('rise').textContent  = fmtLocal(new Date(sunData.data.sunrise));
      document.getElementById('set').textContent   = fmtLocal(new Date(sunData.data.sunset));
      document.getElementById('last').textContent  = fmtLocal(new Date(sunData.data.civil_twilight_end));
    }

    // ---- MOON TRANSIT / ANTITRANSIT IN UTC ----
    const startUTC = new Date(Date.UTC(nowLocal.getUTCFullYear(), nowLocal.getUTCMonth(), nowLocal.getUTCDate()-1));
    const endUTC = new Date(startUTC.getTime() + 3*24*60*60000); // 3 days in ms
    let moonOverheadUTC = null, moonUnderfootUTC = null;
    let maxAlt = -90, minAlt = 90;

    for (let t = startUTC.getTime(); t <= endUTC.getTime(); t += 60000) {
      const pos = SunCalc.getMoonPosition(new Date(t), lat, lng);
      if (pos.altitude > maxAlt) { maxAlt = pos.altitude; moonOverheadUTC = new Date(t); }
      if (pos.altitude < minAlt) { minAlt = pos.altitude; moonUnderfootUTC = new Date(t); }
    }

    // ---- KNIGHT TABLE OFFSET ----
    const KNIGHT_OFFSET = {
      0:0,1:5,2:10,3:15,4:20,5:25,6:30,7:35,8:40,9:45,10:50,11:55,
      12:60,13:62,14:63,15:64,16:63,17:62,18:60,19:55,20:50,21:45,
      22:40,23:35,24:30,25:25,26:20,27:15,28:10,29:5,30:0
    };
    const moonIllumData = SunCalc.getMoonIllumination(nowLocal);
    const moonAge = Math.round(moonIllumData.phase * 29.53);
    const offsetMinutes = KNIGHT_OFFSET[moonAge] || 60;
    const OFFSET_SIGN = 1;
    const applyKnightUTC = dt => dt ? new Date(dt.getTime() + OFFSET_SIGN*offsetMinutes*60000) : null;

    const majorCentersUTC = [];
    if (moonUnderfootUTC) majorCentersUTC.push(moonUnderfootUTC);
    if (moonOverheadUTC) majorCentersUTC.push(moonOverheadUTC);
    majorCentersUTC.sort((a,b) => a.getTime() - b.getTime());
    const major1UTC = majorCentersUTC[0] ? applyKnightUTC(majorCentersUTC[0]) : null;
    const major2UTC = majorCentersUTC[1] ? applyKnightUTC(majorCentersUTC[1]) : null;

    const mkRangeLocal = (centerUTC, minutes) => {
      if (!centerUTC) return '—';
      const s = new Date(centerUTC.getTime() - minutes*60000);
      const e = new Date(centerUTC.getTime() + minutes*60000);
      return `${fmtLocal(s)}–${fmtLocal(e)}`;
    };

    document.getElementById('maj1').innerHTML = mkRangeLocal(major1UTC,60);
    document.getElementById('maj2').innerHTML = `<b>${mkRangeLocal(major2UTC,60)}</b>`;

    // ---- MINOR PERIODS (moonrise/moonset ± 30 min) ----
    const mtToday = SunCalc.getMoonTimes(nowLocal, lat, lng, true);
    const tomorrow = new Date(nowLocal); tomorrow.setDate(tomorrow.getDate()+1);
    const mtTomorrow = SunCalc.getMoonTimes(tomorrow, lat, lng, true);

    const allMinorsUTC = [];
    [mtToday, mtTomorrow].forEach(mt => {
      if (mt.rise) allMinorsUTC.push(mt.rise);
      if (mt.set) allMinorsUTC.push(mt.set);
    });

    const startDay = new Date(nowLocal); startDay.setHours(0,0,0,0);
    const endDay = new Date(startDay); endDay.setDate(endDay.getDate()+1);

    const dayMinorsUTC = allMinorsUTC.filter(t => t >= startDay && t < endDay);
    dayMinorsUTC.sort((a,b) => a.getTime() - b.getTime());

    const minor1UTC = dayMinorsUTC[0] || null;
    const minor2UTC = dayMinorsUTC[1] || null;

    document.getElementById('min1').innerHTML = mkRangeLocal(minor1UTC,30);
    document.getElementById('min2').innerHTML = `<b>${mkRangeLocal(minor2UTC,30)}</b>`;

    // ---- RATING & MOON PHASE ----
    const illumPercent = Math.round(moonIllumData.fraction*100);
    const scoreStars = illumPercent <= 10 || illumPercent >= 90 ? 4 :
                       illumPercent <= 25 || illumPercent >= 75 ? 3 :
                       illumPercent <= 40 || illumPercent >= 60 ? 2 : 1;
    const wordsStars = ['Poor','Fair','Good','Better','Best'];
    document.getElementById('rating').innerHTML = `
      <div style="font-size:36px;color:#003366;">${'★'.repeat(scoreStars)}${'☆'.repeat(4-scoreStars)}</div>
      <div style="font-size:24px;color:#003366;">${wordsStars[scoreStars]}</div>
    `;

    // ---- DAY RATING (UNIQUE VARIABLES) ----
    const solunarDayScore = illumPercent <= 10 || illumPercent >= 90 ? 4 :
                            illumPercent <= 25 || illumPercent >= 75 ? 3 :
                            illumPercent <= 40 || illumPercent >= 60 ? 2 : 1;
    const solunarDayWords = ['Poor','Fair','Good','Better','Best'];
    document.getElementById('day-rating').textContent = `Day Rating: ${solunarDayWords[solunarDayScore]}`;

    // ---- MOON PHASE IMAGE ----
    const phaseName =
      moonIllumData.phase < 0.03 ? 'New Moon' :
      moonIllumData.phase < 0.25 ? 'Waxing Crescent' :
      moonIllumData.phase < 0.26 ? 'First Quarter' :
      moonIllumData.phase < 0.50 ? 'Waxing Gibbous' :
      moonIllumData.phase < 0.51 ? 'Full Moon' :
      moonIllumData.phase < 0.75 ? 'Waning Gibbous' :
      moonIllumData.phase < 0.76 ? 'Last Quarter' :
      'Waning Crescent';

    document.getElementById('phase').textContent = phaseName;
    document.getElementById('illum').textContent = `${illumPercent}% Illuminated`;

    const dirMoon = phaseName.includes('Waxing') ? 'wax' : 'wane';
    const pctMoon = Math.round(illumPercent/5)*5;
    const moonFile = illumPercent === 0 ? 'newmoon.png' :
                     illumPercent === 100 ? 'fullmoon.png' :
                     `${dirMoon}${pctMoon}.png`;
    document.getElementById('moon-img').src = `/images/${moonFile}`;

    // ---- HEADER DATES ----
    document.getElementById('header-date').textContent =
      nowLocal.toLocaleDateString('en-US',{month:'long',day:'numeric'});
    document.getElementById('date').textContent =
      nowLocal.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  }, 500);
});
</script>




</body>
</html>







