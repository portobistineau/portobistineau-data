<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lake Bistineau Weather & Solunar - TEST</title>
    <style>
        body {font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f0f8ff;}
        .banner {width: 100%; text-align: center;}
        .banner-img {max-width: 100%; height: auto;}
        .tagline {text-align: center; font-style: italic; color: #003366; margin: 10px 0;}
        h2 {color: #003366; text-align: center;}
    </style>
</head>
<body>

<!-- BANNER — FULL WIDTH, PERFECT ON MOBILE -->
<div class="banner">
  <img src="banner.jpg" alt="Port O Bistineau Marina" class="banner-img" id="banner">
</div>
<p class="tagline">Your Gateway to Lake Bistineau – Live Lake Views, Lake Updates & More</p>

<script>
  // SECRET DOUBLE-CLICK: index.html → test.html | test.html → stay
  let clicks = 0, timer;
  document.getElementById('banner').addEventListener('click', function(e) {
    clicks++;
    if (clicks === 1) {
      timer = setTimeout(() => clicks = 0, 400);
    } else if (clicks === 2) {
      clearTimeout(timer);
      clicks = 0;
      if (window.location.pathname.includes('index.html') || window.location.pathname === '/') {
        window.location.href = 'test.html';
      }
    }
  });
</script>

<!-- Weather - NATIONAL WEATHER SERVICE (LIVE + HOURLY CACHE + ICON) -->
<div class="section">
  <h2>Lake Bistineau Weather</h2>
  <div id="bistineauWeather">Loading NWS data...</div>
  <div id="dayDetail" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.5);z-index:999;max-width:90%;max-height:90%;overflow:auto;font-family:Arial;"></div>
  <div id="overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:998;" onclick="this.style.display='none';document.getElementById('dayDetail').style.display='none';"></div>
  <script>
  (async () => {
    const lat = 32.4066, lon = -93.3906;
    const now = new Date();
    const today = now.toISOString().slice(0,10);
    const hour = now.getHours();

    // --- Hourly Caching: refresh if date or hour changed ---
    let data = JSON.parse(localStorage.getItem('nwsCache') || 'null');
    if (!data || data.date !== today || data.hour !== hour) {
      document.getElementById('bistineauWeather').innerHTML = 'Fetching fresh NWS data...';
      let grid;
      try {
        const point = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
        grid = point.properties;
      } catch(e) { document.getElementById('bistineauWeather').innerHTML = '<div style="padding:20px;color:red;">NWS offline – refresh later</div>'; return; }

      const [stationsRes, dailyRes, hourlyRes] = await Promise.all([
        fetch(grid.observationStations),
        fetch(grid.forecast),
        fetch(grid.forecastHourly)
      ]);

      const stations = await stationsRes.json();
      const station = stations.observationStations[0];
      const obs = await fetch(`${station}/observations/latest?require_qc=false`).then(r => r.json());

      const daily = await dailyRes.json();
      const hourly = await hourlyRes.json();

      data = {date: today, hour, grid, obs: obs.properties, daily: daily.properties, hourly: hourly.properties};
      localStorage.setItem('nwsCache', JSON.stringify(data));
    }

    // --- Current Observation (for temperature, feels-like, pressure) ---
    const p = data.obs;
    const currentTemp = Math.round(p.temperature.value * 1.8 + 32);
    const feels = Math.round(p.apparentTemperature?.value * 1.8 + 32) || currentTemp;

    const pressure = (p.barometricPressure.value / 3386.39).toFixed(2);
    let trend = '';
    const change = p.pressureChange?.value;
    if (change !== null) {
      const inches = change / 3386.39;
      if (Math.abs(inches) < 0.02) trend = '(steady)';
      else if (inches > 0) trend = '(rising)';
      else trend = '(falling)';
    }

    const timeStr = new Date(p.timestamp).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'});

    // --- Closest hourly forecast (for icon, condition, wind) ---
    const nowDate = now.getTime();
    const closestHourly = data.hourly.periods.reduce((a,b) =>
      Math.abs(new Date(b.startTime) - nowDate) < Math.abs(new Date(a.startTime) - nowDate) ? b : a
    );

    const currentIcon = closestHourly?.icon?.replace('large','medium') || '';
    const currentForecast = closestHourly?.shortForecast || '';

    // Parse wind speed and direction from forecast string (e.g., "10 mph", "5 to 10 mph")
    let windSpeedAvg = 0;
    if (closestHourly?.windSpeed) {
      const nums = closestHourly.windSpeed.match(/\d+/g)?.map(Number) || [];
      if (nums.length === 1) windSpeedAvg = nums[0];
      else if (nums.length === 2) windSpeedAvg = Math.round((nums[0] + nums[1]) / 2);
    }
    const windDir = closestHourly?.windDirection || '';

    const currentHTML = `
      <div style="background:#fff;padding:15px;border-radius:12px;margin-bottom:15px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.1);">
        <div style="font-size:28px;font-weight:bold;">${currentTemp}°F</div>
        <div style="margin:8px 0;">
          <img src="${currentIcon}" width="85" height="85" style="vertical-align:middle;margin:0 auto;display:block;">
          <div style="font-size:14px;color:#666;margin-top:4px;">${currentForecast}</div>
        </div>
        <div style="color:#666;margin-bottom:8px;">Feels ${feels}°F • As of ${timeStr}</div>
        <div style="font-size:14px;line-height:1.6;">
          Wind ${windSpeedAvg} mph ${windDir}<br>
          Pressure ${pressure} inHg ${trend}<br>
        </div>
      </div>`;

    // --- 7-Day Forecast Cards ---
    let forecastHTML = '<div style="display:flex;justify-content:center;flex-wrap:wrap;gap:12px;padding:15px;background:#f0f8ff;border-radius:15px;">';
    const dailyPeriods = data.daily.periods.slice(0, 14);

    for (let i = 0; i < 7; i++) {
      const day = dailyPeriods[i*2];
      const night = dailyPeriods[i*2 + 1] || day;
      const dayDate = new Date();
      dayDate.setDate(dayDate.getDate() + i);
      const dayName = i===0 ? 'Today' : dayDate.toLocaleDateString('en-US', { weekday:'short' });
      const icon = day.icon.replace('large','medium');

      const startOfDay = new Date();
      startOfDay.setHours(0,0,0,0); startOfDay.setDate(startOfDay.getDate() + i);
      const endOfDay = new Date(startOfDay); endOfDay.setHours(23,59,59,999);

      const dayHours = data.hourly.periods.filter(p => {
        const t = new Date(p.startTime);
        return t >= startOfDay && t <= endOfDay;
      });

      const hi = dayHours.length ? Math.max(...dayHours.map(p=>p.temperature)) : day.temperature;
      const lo = dayHours.length ? Math.min(...dayHours.map(p=>p.temperature)) : night.temperature;

      forecastHTML += `
        <div onclick="showDetail(${i})" style="cursor:pointer;width:100px;height:170px;background:#fff;padding:8px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);text-align:center;display:flex;flex-direction:column;justify-content:space-between;">
          <div style="font-weight:bold;color:#003366;">${dayName}</div>
          <div style="flex:1;display:flex;align-items:center;justify-content:center;">
            <img src="${icon}" width="48" height="48">
          </div>
          <div style="font-size:16px;font-weight:bold;">${hi}°<span style="font-size:12px;color:#666;">/${lo}°</span></div>
          <div style="font-size:11px;line-height:1.25;height:40px;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;">
            ${day.shortForecast}
          </div>
        </div>`;
    }
    forecastHTML += '</div>';

    document.getElementById('bistineauWeather').innerHTML = currentHTML + forecastHTML;

    // --- POPUP DETAIL VIEW ---
    window.showDetail = function(dayIndex) {
      const startOfDay = new Date();
      startOfDay.setHours(0,0,0,0); startOfDay.setDate(startOfDay.getDate() + dayIndex);
      const endOfDay = new Date(startOfDay); endOfDay.setHours(23,59,59,999);

      const periods = data.hourly.periods.filter(p => {
        const t = new Date(p.startTime);
        return t >= startOfDay && t <= endOfDay;
      });

      let detailHTML = `<h3 style="margin-top:0;text-align:center;">${startOfDay.toLocaleDateString('en-US',{weekday:'long', month:'long', day:'numeric'})}</h3><div style="max-height:60vh;overflow-y:auto;">`;
      periods.forEach(p => {
        const time = new Date(p.startTime).toLocaleTimeString('en-US', {hour:'numeric'});
        const temp = p.temperature;
        const windStr = p.windSpeed.replace(' mph','');
        const dir = p.windDirection;
        detailHTML += `
          <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;font-size:14px;">
            <div style="width:50px;">${time}</div>
            <img src="${p.icon.replace('large','small')}" width="32" height="32">
            <div style="width:60px;text-align:right;font-weight:bold;">${temp}°</div>
            <div style="width:80px;text-align:center;">${windStr} ${dir}</div>
            <div style="width:50px;text-align:right;">${p.probabilityOfPrecipitation.value || 0}%</div>
          </div>`;
      });
      detailHTML += `</div><div style="text-align:center;margin-top:10px;"><button onclick="document.getElementById('overlay').style.display='none';document.getElementById('dayDetail').style.display='none';" style="padding:8px 16px;background:#003366;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button></div>`;
      document.getElementById('dayDetail').innerHTML = detailHTML;
      document.getElementById('dayDetail').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    };
  })();
  </script>
</div>
    
<!-- TODAY’S BITE FORECAST – CLEANED UP (LOCAL MIDNIGHT FIX, MINOR PERIOD FIX) -->
<div style="margin:30px auto;max-width:1000px;background:white;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,0.1);font-family:Arial;">
  <h2 style="text-align:center;margin:0 0 20px;color:#000;font-size:28px;">
    Solunar Times for <span id="header-date">—</span>
  </h2>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <!-- LEFT COLUMN: TIMES -->
    <div style="flex:2;background:#f8fdff;padding:25px;border-radius:12px;">
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px 10px;line-height:1.35;font-size:16px;">
        <b>First Light</b> <div id="first" style="text-align:right;">Calculating…</div>
        <b>Sunrise</b> <div id="rise" style="text-align:right;">Calculating…</div>
        <b>Major Period 1</b> <div id="maj1" style="text-align:right;">Calculating…</div>
        <b>Major Period 2</b> <div id="maj2" style="text-align:right;">Calculating…</div>
        <b>Minor Period 1</b> <div id="min1" style="text-align:right;">Calculating…</div>
        <b>Minor Period 2</b> <div id="min2" style="text-align:right;">Calculating…</div>
        <b>Sunset</b> <div id="set" style="text-align:right;">Calculating…</div>
        <b>Last Light</b> <div id="last" style="text-align:right;">Calculating…</div>
      </div>
      <p style="font-size:13px;color:#003366;margin-top:15px;text-align:center;">
        <b>Bold</b> periods indicate the stronger feeding time of each group.
      </p>
    </div>

    <!-- RIGHT COLUMN: MOON / RATING -->
    <div style="flex:1;background:white;padding:25px;border-radius:12px;text-align:center;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
      <div id="rating" style="font-size:30px;color:#000;line-height:1.5;">Calculating…</div>
      <div id="moon-bg" style="width:90px;height:90px;background:#002244;border-radius:50%;margin:12px auto;padding:5px;">
        <img id="moon-img" src="" width="90" height="90" style="border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
      </div>
      <div id="phase" style="font-weight:bold;font-size:16px;color:#000;margin:8px 0 4px;">—</div>
      <div id="illum" style="color:#000;font-size:16px;">—</div>
    </div>
  </div>

  <p style="text-align:center;color:#003366;font-size:12px;margin-top:22px;">
    Updated <span id="date">—</span> – Refresh for latest
  </p>
</div>

<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
<script>
// Utility function to convert UTC string to local time (CST will happen automatically)
const fmt = d => d.toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit'});

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const lat = 32.4619, lng = -93.3486;
    const now = new Date();
    
    // ---- SUN TIMES (Keep this block) ----
    let sun = JSON.parse(localStorage.getItem('sunCache') || 'null');
    const today = now.toISOString().slice(0,10);
    if (!sun || sun.date !== today) {
      fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`)
        .then(r => r.json())
        .then(j => {
          if (j.status === "OK") {
            sun = {date: today, data: j.results};
            localStorage.setItem('sunCache', JSON.stringify(sun));
          }
        })
        .catch(() => {});
    }
    if (sun) {
      document.getElementById('first').textContent = fmt(new Date(sun.data.civil_twilight_begin));
      document.getElementById('rise').textContent   = fmt(new Date(sun.data.sunrise));
      document.getElementById('set').textContent    = fmt(new Date(sun.data.sunset));
      document.getElementById('last').textContent   = fmt(new Date(sun.data.civil_twilight_end));
    }
    
    // ----------------------------------------------------------------------
    // --- START: NEW ACCURATE SOLUNAR DATA INTEGRATION ---
    // ----------------------------------------------------------------------

    const todayKey = now.toISOString().slice(0, 10); // e.g., "2025-11-13"

    fetch('/solunar_data.json')
      .then(response => {
        if (!response.ok) throw new Error("Could not fetch data.");
        return response.json();
      })
      .then(fullData => {
        const dayData = fullData[todayKey];
        if (!dayData) throw new Error("Data missing for today.");

        // ---- KNIGHT OFFSET TABLE (Keep this table definition) ----
        const KNIGHT_OFFSET = {
          0:0,1:5,2:10,3:15,4:20,5:25,6:30,7:35,8:40,9:45,10:50,11:55,
          12:60,13:62,14:63,15:64,16:63,17:62,18:60,19:55,20:50,21:45,
          22:40,23:35,24:30,25:25,26:20,27:15,28:10,29:5,30:0
        };

        const moonAge = dayData.moon_age;
        const offsetMinutes = KNIGHT_OFFSET[moonAge] || 60;
        
        // Function to apply the Knight offset after converting from UTC string
        const applyKnight = utcStr => {
            if (!utcStr) return null;
            const dt = new Date(utcStr);
            return new Date(dt.getTime() + offsetMinutes * 60000);
        };

        // Apply offset to Majors 
        const major1Center = applyKnight(dayData.major_1_utc);
        const major2Center = applyKnight(dayData.major_2_utc);
        
        // Apply offset to Minors
        const min1Center = applyKnight(dayData.minor_1_utc);
        const min2Center = applyKnight(dayData.minor_2_utc);

        const mkRange = (center, minutes) => {
          if (!center) return '—';
          const s = new Date(center.getTime() - minutes*60000);
          const e = new Date(center.getTime() + minutes*60000);
          return `${fmt(s)}–${fmt(e)}`;
        };

        // Display the accurate, adjusted times
        document.getElementById('maj1').innerHTML = mkRange(major1Center, 60);
        document.getElementById('maj2').innerHTML = `<b>${mkRange(major2Center, 60)}</b>`;
        document.getElementById('min1').innerHTML = mkRange(min1Center, 30);
        document.getElementById('min2').innerHTML = `<b>${mkRange(min2Center, 30)}</b>`;

        // ---- RATING (Update rating and phase using accurate JSON data) ----
        const illum = dayData.moon_illum;
        let score = 1;
        if (illum >= 99 || illum <= 1) score = 5;
        else if (illum >= 95 || illum <= 5) score = 4;
        else if (illum >= 90 || illum <= 10) score = 3;
        else if (illum >= 80 || illum <= 20) score = 2;
        else score = 1;

        const labels = ['Poor', 'Fair', 'Good', 'Better', 'Best'];
        const stars = '★'.repeat(score - 1);
        document.getElementById('rating').innerHTML = `
          <div style="font-size:36px;color:#003366;">${stars}</div>
          <div style="font-size:24px;color:#003366;">${labels[score - 1]}</div>
        `;
        
        // ---- MOON PHASE / IMAGE (Use the more accurate moon_age and illum) ----
        const phaseFraction = dayData.moon_age / 29.53; // Reconstruct phase fraction (0 to 1)
        
        // --- CORRECTED PHASE NAMING LOGIC ---
        let phaseName;
        if (phaseFraction < 0.03 || phaseFraction > 0.97) {
            phaseName = 'New Moon';
        } else if (phaseFraction < 0.25) {
            phaseName = 'Waxing Crescent';
        } else if (phaseFraction < 0.26) {
            phaseName = 'First Quarter';
        } else if (phaseFraction < 0.50) {
            phaseName = 'Waxing Gibbous';
        } else if (phaseFraction < 0.53) {
            phaseName = 'Full Moon';
        } else if (phaseFraction < 0.75) {
            phaseName = 'Waning Gibbous';
        } else if (phaseFraction < 0.76) {
            phaseName = 'Last Quarter';
        } else {
            // This captures the remaining phase: 0.76 up to 0.97 (Waning Crescent)
            phaseName = 'Waning Crescent'; 
        }
        
        // Display phase name and illumination percentage
        document.getElementById('phase').textContent = phaseName;
        document.getElementById('illum').textContent = `${Math.round(illum)}% Illuminated`;
        
        // Determine moon image (This logic remains the same, just using new 'illum' and 'phaseName')
        let moonFile = '';
        // ... (Keep your original logic for setting moonFile based on phaseName/illum here)
        if (illum === 0) {
            moonFile = 'newmoon.png';
        } else if (illum === 100) {
            moonFile = 'fullmoon.png';
        } else if (phaseName.includes('First Quarter')) {
            moonFile = 'firstquart.png';
        } else if (phaseName.includes('Last Quarter')) {
            moonFile = 'lastquart.png';
        } else {
            const dir = phaseName.includes('Waxing') ? 'wax' : 'wane';
            let pct = Math.round(illum); 

            // Custom ranges for missing images
            if (pct > 45 && pct < 50) pct = 45;
            else if (pct > 50 && pct < 55) pct = 55;
            if (dir === 'wane' && pct === 33) pct = 32;

            moonFile = `${dir}${pct}.png`;
        }

        document.getElementById('moon-img').src = `/images/${moonFile}`;
        
      })
      .catch(error => {
        console.error("Error fetching solunar data:", error);
        // Fallback: If JSON fails, use the old SunCalc Moon Illumination (optional)
        const localMidnight = new Date();
        localMidnight.setHours(0, 0, 0, 0);
        const illumData = SunCalc.getMoonIllumination(localMidnight);
        // ... re-run old rating/phase logic here if needed for a complete fallback
      });

    // ----------------------------------------------------------------------
    // --- END: NEW ACCURATE SOLUNAR DATA INTEGRATION ---
    // ----------------------------------------------------------------------

    // ---- FIXED MINOR PERIOD LOGIC ----
    // This original section is now deleted, as the Minors are calculated above.
    
    // ---- RATING ----
    const illum = Math.round(illumData.fraction * 100);
    let score = 1;
    if (illum >= 99 || illum <= 1) score = 5;
    else if (illum >= 95 || illum <= 5) score = 4;
    else if (illum >= 90 || illum <= 10) score = 3;
    else if (illum >= 80 || illum <= 20) score = 2;
    else score = 1;

    const labels = ['Poor', 'Fair', 'Good', 'Better', 'Best'];
    const stars = '★'.repeat(score - 1);
    document.getElementById('rating').innerHTML = `
      <div style="font-size:36px;color:#003366;">${stars}</div>
      <div style="font-size:24px;color:#003366;">${labels[score - 1]}</div>
    `;

    // ---- MOON PHASE / IMAGE ----
    const phase = illumData.phase;
    const phaseName =
      phase < 0.03 ? 'New Moon' :
      phase < 0.25 ? 'Waxing Crescent' :
      phase < 0.26 ? 'First Quarter' :
      phase < 0.50 ? 'Waxing Gibbous' :
      phase < 0.51 ? 'Full Moon' :
      phase < 0.75 ? 'Waning Gibbous' :
      phase < 0.76 ? 'Last Quarter' :
      'Waning Crescent';

    // ---- MOON PHASE / ILLUMINATION / IMAGE ----

// Display phase name and illumination percentage
document.getElementById('phase').textContent = phaseName;
document.getElementById('illum').textContent = `${illum}% Illuminated`;

// Determine moon image
let moonFile = '';

if (illum === 0) {
  // New Moon
  moonFile = 'newmoon.png';
} else if (illum === 100) {
  // Full Moon
  moonFile = 'fullmoon.png';
} else if (phaseName.includes('First Quarter')) {
  moonFile = 'firstquart.png';
} else if (phaseName.includes('Last Quarter')) {
  moonFile = 'lastquart.png';
} else {
  // Waxing or Waning
  const dir = phaseName.includes('Waxing') ? 'wax' : 'wane';
  let pct = illum; // Use exact illumination value

  // Custom ranges for missing images
  if (pct > 45 && pct < 50) pct = 45;
  else if (pct > 50 && pct < 55) pct = 55;

  // Specific exception for waning
  if (dir === 'wane' && pct === 33) pct = 32;

  moonFile = `${dir}${pct}.png`;
}

// Set the image source
document.getElementById('moon-img').src = `/images/${moonFile}`;



    // ---- DATE LABELS ----
    document.getElementById('header-date').textContent = now.toLocaleDateString('en-US',{month:'long',day:'numeric'});
    document.getElementById('date').textContent = now.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  }, 500);
});
</script>





</body>
</html>































